<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0,viewport-fit=cover">
  <title>San BOT</title>
  <style>
  </style>
  <link rel="stylesheet" href="styles.css">
  <script src="script.js"></script>
</head>

<header>
  <div class="circle">
    <img id="pictureUrl" style="width:100%;">
  </div>
  <div class="column">
    <h1>
      <p id="displayName"></p>
    </h1>
    <h3>
      <p id="userId"></p>
      <p id="statusMessage"></p>
    </h3>
  </div>
</header>

<body id="body">

  <main>
    <section>
      <div class="row">
        <select id="selector" onchange="goToSelectedPage()">
          <option value="index">‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏</option>
          <option value="botip">‡πÄ‡∏ä‡πá‡∏Ñ IP Address</option>
          <option value="page3">San APP</option>
        </select>
      </div>
      <div class="row">
        <button id="btnLogin" onclick="liff.login()">Log In</button>
        <button id="btnLogOut" onclick="logOut()">Log Out</button>
      </div>
    </section>

    <!--=============================== ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î =======================-->
    <section id="formreport">
      <div class="input-box">
        <form id="mainform">
          <div class="row">
            <input type="date" id="datetime">
            <input list="userlist" id="user" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô">
            <datalist id="userlist">
              <option value="‡∏ä‡∏∏‡∏î‡∏™‡∏∑‡∏ö‡∏™‡∏ß‡∏ô">
              <option value="‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏ß‡∏£ 20">
              <option value="‡∏™‡∏≤‡∏¢‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏Ç‡∏ï">
              <option value="‡∏™‡∏≤‡∏¢‡∏ï‡∏£‡∏ß‡∏à‡∏ï‡∏π‡πâ‡∏¢‡∏≤‡∏°">
            </datalist>
          </div>
          <label for="deail">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</label>
          <textarea id="detail" cols="100" rows="5"></textarea>
          <label for="latlong">‡∏û‡∏¥‡∏Å‡∏±‡∏î:</label>
          <input type="text" id="latlong">
        </form>
      </div>
      <div class="row">
        <button id="btnsettext" onclick="settext()">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
        <button id="btnsend">‡∏™‡πà‡∏á</button>
        <button id="btnShare">‡πÅ‡∏ä‡∏£‡πå</button>
      </div>
    </section>

    <!--=============================== ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î =======================-->
    <section id="formbot">
      <div class="input-box">
        <input type="text" id="txtkey" placeholder="Keywords | ‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤">
      </div>
      <div class="row">
        <button id="btnbotcheck">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button>
        <button id="btnbotsend">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>
      </div>
    </section>
  </main>

  <footer>
    <h3>‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ San Kunakorn | ‡∏á‡∏≤‡∏ô‡∏™‡∏∑‡∏ö‡∏™‡∏ß‡∏ô ‡∏™‡∏†.‡∏ô‡∏¥‡∏Ñ‡∏°‡∏û‡∏±‡∏í‡∏ô‡∏≤ ‡∏†.‡∏à‡∏ß.‡∏£‡∏∞‡∏¢‡∏≠‡∏á</h3>
  </footer>

  <script>

    document.addEventListener("DOMContentLoaded", function () {
      document.getElementById("btnsend").addEventListener("click", function () {
        sendMessagebot(settext());
      });
      document.getElementById("btnShare").addEventListener("click", function () {
        shareMessage(settext());
      });

      document.getElementById("btnbotcheck").addEventListener("click", function () {
        const txtbotValue = document.getElementById("txtkey").value;
        getIpLocation(txtbotValue)
          .then(() => {
            alert('Success');
          })
          .catch((error) => {
            alert('Error:', error);
          });
      });


      document.getElementById("btnbotsend").addEventListener("click", function () {
        fetchDataAndSendMessage()
          .then(() => {
            alert('Success');
          })
          .catch((error) => {
            alert('Error:', error);
          });
      });

    });
  </script>

  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>
  <script>

    async function shareMessage(message) {
      const result = await liff.shareTargetPicker([
        {
          type: "text",
          text: message,// ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå
        },
      ])
      if (result) {
        alert(`[${result.status}] Message sent!`)
      } else {
        const [majorVer, minorVer, patchVer] = (liff.getLineVersion() || "").split('.');
        if (minorVer === undefined) {
          alert('ShareTargetPicker was canceled in external browser')
        }
        if (parseInt(majorVer) >= 10 && parseInt(minorVer) >= 10 && parseInt(patchVer) > 0) {
          alert('ShareTargetPicker was canceled in LINE app')
        }
      }
    }

    async function fetchDataAndSendMessage() {
      try {
        const userInput = document.getElementById("txtkey").value;
        const response = await fetch(`http://ip-api.com/json/${userInput}`);
        const data = await response.json();
        const message = await IptoText(data);
        alert(message);
        await sendMessagebot(message);
      } catch (error) {
        alert('Error:', error);
      }
    }


    async function getIpLocation(ip) {
      try {
        const response = await fetch(`http://ip-api.com/json/${ip}`);
        const ipData = await response.json();
        const ipMessage = {
          type: 'flex',
          altText: 'IP Information',
          contents: {
            type: 'bubble',
            body: {
              type: 'box',
              layout: 'vertical',
              contents: [
                {
                  type: 'text',
                  text: 'IP Information',
                  weight: 'bold',
                  size: 'xl'
                },
                {
                  type: 'text',
                  text: `IP Address: ${ipData.query}`
                },
                {
                  type: 'text',
                  text: `üìç‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®: ${ipData.country} : ${ipData.countryCode}`
                },
                {
                  type: 'text',
                  text: `üìç‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: ${ipData.region} : ${ipData.regionName}`
                },
                {
                  type: 'text',
                  text: `üìç‡πÄ‡∏°‡∏∑‡∏≠‡∏á: ${ipData.city}`
                },
                {
                  type: 'text',
                  text: `üìçTimezone: ${ipData.timezone}`
                },
                {
                  type: 'text',
                  text: `üìç‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£: ${ipData.isp}`
                },
                {
                  type: 'text',
                  text: `üìçOrg: ${ipData.org}`
                },
                {
                  type: 'text',
                  text: `üìçAs: ${ipData.as}`
                }
              ]
            },
            footer: {
              type: 'box',
              layout: 'vertical',
              contents: [
                {
                  type: 'button',
                  action: {
                    type: 'uri',
                    label: 'View on Map',
                    uri: `https://maps.google.com?q=${ipData.lat},${ipData.lon}`
                  }
                }
              ]
            }
          }
        };

        await liff.sendMessages([ipMessage]);
        liff.closeWindow();

      } catch (error) {
        console.error('Error fetching IP location:', error);
        throw error;
      }
    }









    async function sendFlex(message) {
      var flexMessage = {
        "type": "flex",
        "altText": "‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö",
        "contents": {
          "type": "bubble",
          "header": {
            "type": "box",
            "layout": "vertical",
            "contents": [
              {
                "type": "text",
                "text": "‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤",
                "weight": "bold",
                "size": "xl",
                "align": "center"
              },
              {
                "type": "box",
                "layout": "baseline",
                "spacing": "sm",
                "contents": [
                  {
                    "type": "icon",
                    "url": "https://scdn.line-apps.com/n/channel_devcenter/img/fx/review_gold_star_28.png"
                  },
                  {
                    "type": "text",
                    "text": 'San Bot',
                    "wrap": true,
                    "color": "#666666",
                    "size": "sm",
                    "flex": 5
                  }
                ]
              }
            ]
          },
          "body": {
            "type": "box",
            "layout": "vertical",
            "margin": "lg",
            "spacing": "sm",
            "contents": [
              {
                "type": "box",
                "layout": "baseline",
                "spacing": "sm",
                "contents": [
                  {
                    "type": "text",
                    "text": "Results",
                    "color": "#aaaaaa",
                    "size": "sm",
                    "flex": 1
                  },
                  {
                    "type": "text",
                    "text": message,//‡∏ú‡∏•
                    "wrap": true,
                    "color": "#666666",
                    "size": "sm",
                    "flex": 5
                  }
                ]
              },
              {
                "type": "separator"
              }
            ]
          },
          "footer": {
            "type": "box",
            "layout": "vertical",
            "spacing": "sm",
            "contents": [
              {
                "type": "separator"
              },
              {
                "type": "button",
                "style": "link",
                "height": "sm",
                "action": {
                  "type": "uri",
                  "label": "San BOT",
                  "uri": "http://line.me/ti/p/~@223zypdp",
                },
                "color": "#00FF66"
              },
            ],
            "flex": 0
          },
          "styles": {
            "header": {
              "backgroundColor": "#99FFFF"
            }
          }
        }
      }
      try {
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ LIFF API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        await liff.sendMessages([flexMessage]);
        alert("Message sent successfully!");
        liff.closeWindow();
      } catch (error) {
        alert("Error occurred while trying to send message:", error);
      }
    }


    async function sendMessagebot(message) {
      try {
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ LIFF API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        await liff.sendMessages([
          {
            type: 'text',
            text: message, // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á
          }
          // ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
        ]);
        alert("Message sent successfully!");
        liff.closeWindow();
      } catch (error) {
        alert("Error occurred while trying to send message:", error);
      }
    }
    //‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    function goToSelectedPage() {
      var selectedPage = document.getElementById("selector").value;
      switch (selectedPage) {
        case "index":
          document.getElementById("formbot").style.display = "none";
          document.getElementById("formreport").style.display = "block";
          break;

        case "botip":
          document.getElementById("formreport").style.display = "none";
          document.getElementById("formbot").style.display = "block";
          break;

        case "page3":
          window.location.href = 'https://san-all.web.app';
          break;

        default:
          document.getElementById("formip").style.display = "none";
          document.getElementById("formreport").style.display = "block";
          break;
      }
    }



    function logOut() {
      liff.logout()
      window.location.reload()
    }

    async function getUserProfile() {
      try {
        const profile = await liff.getProfile();
        const pictureUrl = document.getElementById("pictureUrl");
        const userId = document.getElementById("userId");
        const displayName = document.getElementById("displayName");
        const statusMessage = document.getElementById("statusMessage");
        pictureUrl.src = profile.pictureUrl;
        displayName.innerHTML = profile.displayName;
        //userId.innerHTML = profile.userId;
        //statusMessage.innerHTML = "<b>statusMessage:</b> " + profile.statusMessage;
      } catch (error) {
        console.error("Error occurred while trying to get user profile:", error);
      }
    }


    async function main() {
      liff.ready.then(() => {
        if (liff.getOS() === "android") {
          body.style.backgroundColor = "#88888";
        }
        else if (liff.getOS() === "web") {
          body.style.backgroundColor = "#88888";
        }
        else if (liff.getOS() === "ios") {
          body.style.backgroundColor = "#88888";
        }
      })
      await liff.init({ liffId: "2004593216-XbA9wj26" })
      // ,withLoginOnExternalBrowser: true
      if (liff.isLoggedIn()) {
        getUserProfile()
        document.getElementById("btnLogin").style.display = "none";
        if (liff.isInClient() && userAgent.includes("Line")) {
          statusMessage.innerHTML = 'LIFF is running in the LINE app.';
        }
        else if (!liff.isInClient()) {
          statusMessage.innerHTML = 'LIFF is not running in the LINE app';
        }
      } else {
        //liff.login({ redirectUri: "https://sankunakorn.github.io/sanbot-liff/" })
        document.getElementById("btnLogin").style.display = "block";
        document.getElementById("btnLogOut").style.display = "none";
      }
      //‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
      var today = new Date();
      // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ISO (YYYY-MM-DD)
      var isoDate = today.toISOString().split('T')[0];
      // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö input
      document.getElementById('datetime').value = isoDate;
      //‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
      goToSelectedPage()
    }
    main()
  </script>
</body>

</html>